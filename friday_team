#coups = population + income/cap + some weather thing

rm(list=ls())
source("https://raw.githubusercontent.com/thynec/CoupCats/refs/heads/main/libraries.R") 

#build baseline dataset; ccode-year
base <- create_stateyears(subset_years = 1950:2025, system = "cow")

##bring in coups
url <- "http://www.uky.edu/~clthyn2/coup_data/powell_thyne_coups_final.xls"
destfile <- "powell_thyne_coups_final.xls"
curl::curl_download(url, destfile)
coups <- read_excel(destfile)
rm(destfile, url)
#collapse coups so we have 1 ccode/year
coups <- coups %>%
  group_by(ccode, year) %>%
  summarise(tot=sum(coup)) %>%
  mutate(coup=1) %>%
  set_variable_labels(coup="1 if 1+ coup attempt") %>%
  select(-tot) %>%
  ungroup()
base <- base %>%
  left_join(coups, by=c("ccode", "year")) 
base <- base %>%
  mutate(coup=ifelse(is.na(coup), 0, coup))


url <- "http://www.uky.edu/~clthyn2/replace_ccode_country.xls"
destfile <- "replace_ccode_country.xls"
curl::curl_download(url, destfile)
replace_ccode_country <- read_excel(destfile)



#Coups vs population

# load population data
library(readxl)
url <- "https://api.worldbank.org/v2/en/indicator/SP.POP.TOTL?downloadformat=excel"
destfile <- "SP_POP.xls"
curl::curl_download(url, destfile)
population_total <- read_excel(destfile, skip = 2)

# transpose population data
pivot_pop <- population_total %>%
  pivot_longer(
    cols = -c(`Country Name`, `Country Code`, 'Indicator Name', 'Indicator Code'),
    names_to = "year",
    values_to = "population"
  )
rm(population_total)
# load country code
library(readxl)
url <- "http://www.uky.edu/~clthyn2/replace_ccode_country.xls"
destfile <- "replace_ccode_country.xls"
curl::curl_download(url, destfile)
replace_ccode_country <- read_excel(destfile)

# Join them to get the correct ccode
merged_data <- left_join(replace_ccode_country, pivot_pop,
                         by = c("country" = "Country Name"))

#coups vs temp
library(readr)
temp <- read_csv("Downloads/GDL-Yearly-Average-Surface-Temperature-(ÂºC)-data.csv")

temp_long <- temp %>%
  pivot_longer(
    cols = -c(Country,Continent,ISO_Code,Level,GDLCODE,Region),
    names_to = "year",
    values_to = "temperature"
  )

rm(temp)

temp_long <- temp_long %>%
  select(Country,year,temperature)

temp_long$year <- as.numeric(temp_long$year)

library(readxl)
url <- "http://www.uky.edu/~clthyn2/replace_ccode_country.xls"
destfile <- "replace_ccode_country.xls"
curl::curl_download(url, destfile)
replace_ccode_country <- read_excel(destfile)
rm(destfile,url)

mtemp <- temp_long %>%
  left_join(replace_ccode_country, by=c("Country"="country","year"="year")) %>%
  relocate(ccode) %>%
  drop_na() 

rm(replace_ccode_country,temp_long)

mtemp <- mtemp %>%
  select(ccode,year,temperature)

mtemp <- mtemp %>%
  group_by(ccode, year) %>%
  summarise(temperature = mean(temperature, na.rm = TRUE)) %>%
  ungroup()

merged_base <- base %>%
  left_join(mtemp, by=c("ccode" = "ccode", "year" = "year")) %>%
  drop_na()

rm(base,coups,mtemp)



